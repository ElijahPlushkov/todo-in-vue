<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <title>Document</title>

    <style>
        .my-card {
            margin-bottom: 15px;
        }

        .completetodo {
            background: green;

        }

        .incompletetodo {
            background: rosybrown;
        }

        .logoDark {
            border: 2px solid black;
        }

        .logoGreen {
            border: 2px solid green;
        }
        .selected-todo-border {
            border: 2px solid red;
        }
    </style>
</head>

<body>
<div class="container" id="vue-app">

    <header-comp :logo-dark="cssClassLogo" @click="changeLogoColor()"></header-comp>
    <div class="row">
        <div class="col-12">
            <title-comp :sub-title="subTitle"></title-comp>
        </div>
    </div>

    <div class="row">
        <div class="col-6">
            <todo-card-comp v-for="(todo, index) in todos" :key="todo.id"
                            :todo="todo"
                            :selected-todo-id="selectedTodoId"
                            @change-todo-status="changeTodoStatus"
                            @delete-todo="deleteTodo"
                            @select-todo-id="selectTodoId"

            ></todo-card-comp>
        </div>

        <div class="col-6">
            <button type="button" class="btn btn-outline-primary" @click="selectFormMode()">Todo Task</button>
            <button type="button" class="btn btn-outline-success" @click="selectFormMode()">Subtask</button>

            <div v-if="formMode === 'task'">
                <form @submit.prevent="addTodo()">
                    <h2>Todo Task</h2>
                    <div class="mb-3">
                        <label for="todo" class="form-label">Todo Name</label>
                        <input v-model="todoName" type="text" class="form-control" id="todo"
                               placeholder="enter your todo">
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea v-model="todoDescription" class="form-control" id="description" rows="3"></textarea>
                    </div>
                    <button class="btn btn-primary" type="submit">Submit</button>
                </form>
            </div>
            <div v-else>
                <form>
                    <h2>Subtask</h2>
                    <div class="mb-3">
                        <label for="subtask" class="form-label">Subtask name</label>
                        <input v-model="subtaskName" type="text" class="form-control" id="subtask"
                               placeholder="enter subtask">
                    </div>
                    <div class="mb-3">
                        <label for="time" class="form-label">Estimated time</label>
                        <input v-model="subtaskEstimatedTime" type="number" class="form-control" id="time"
                               placeholder="enter time">
                    </div>
                    <div class="mb-3">
                        <label for="executor" class="form-label">Executor</label>
                        <input v-model="subtaskExecutor" type="text" class="form-control" id="executor"
                               placeholder="enter a name">
                    </div>
                    <button class="btn btn-primary" type="submit">Submit</button>
                </form>
            </div>
        </div>

    </div>
</div>

<script src="components/LogoComp.js"></script>
<script src="components/HeaderComp.js"></script>
<script src="components/TitleComp.js"></script>
<script src="components/TodoCardComp.js"></script>

<script defer>

    Vue.createApp({
        components: {
            'title-comp': TitleComp,
            'header-comp': HeaderComp,
            'todo-card-comp': TodoCardComp
        },
        data() {
            return {
                todos: [],
                todoName: '',
                todoDescription: '',
                isTodoCompleted: false,
                subTitle: 'good day',
                cssClassLogo: 'logoGreen',
                formMode: 'task', // task and subtask

                subtaskName: '',
                subtaskExecutor: '',
                subtaskEstimatedTime: '',
                selectedTodoId: ''
            }
        },
        methods: {
            addTodo() {
                this.todos.push({
                    id: this.calculateNextId(),
                    name: this.todoName,
                    isDone: false,
                    description: this.todoDescription
                })
                this.todoName = ''
                this.todoDescription = ''
                this.todos = this.sortByStatusAndId()
            },
            calculateNextId() {
                return Math.max(...this.todos.map(todo => todo.id)) + 1
            },
            changeTodoStatus(todo) {
                todo.isDone = !todo.isDone
                this.todos = this.sortByStatusAndId()
            },
            sortByStatusAndId() {
                return this.todos.sort((a, b) => {
                    // Сначала сортируем по статусу (невыполненные первыми)
                    if (a.isDone !== b.isDone) {
                        return a.isDone ? 1 : -1;
                    }
                    // Если статус одинаковый, сортируем по ID
                    return a.id - b.id;
                });
            },
            changeLogoColor() {
                this.cssClassLogo = this.cssClassLogo === 'logoGreen' ? 'logoDark' : 'logoGreen'
            },
            deleteTodo(id) {
                this.todos = this.todos.filter((todo) => todo.id !== id)
                this.todos = this.sortByStatusAndId()
            },
            selectFormMode() {
                this.formMode = this.formMode === 'task' ? 'subtask' : 'task'
            },
            selectTodoId(id) {
                this.formMode = 'subtask'
                let todo = this.todos.find((todo) => todo.id === id)
                this.selectedTodoId = todo.id
                console.log(this.selectedTodoId)
            }
        },
        mounted() {
            let url = "http://localhost:8080/api/gettodos"
            fetch(url)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("smth wrong")
                    } else {
                        return response.json()
                    }
                })
                .then((data) => {
                    this.todos = data.todos
                })
                .catch((error) => {
                    let todos = [
                        {id: 1, name: "do", isDone: false, description: "longer text"},
                        {id: 2, name: "make", isDone: true, description: "longer text"}
                    ]

                    this.todos = todos
                })
        }

    }).mount("#vue-app")

</script>
</body>

</html>